name: CI/CD Build & Deploy

on:
  push:
    branches: ["main", "staging"] # Ch·∫°y khi push v√†o Main ho·∫∑c Staging
    # Ch·ªâ ch·∫°y khi c√≥ thay ƒë·ªïi trong c√°c th∆∞ m·ª•c code (ƒë·ªÉ ti·∫øt ki·ªám t√†i nguy√™n)
    paths:
      - "apps/**"
      - "packages/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "Dockerfile"
      - ".github/workflows/deploy.yml"
  workflow_dispatch: # N√∫t b·∫•m ch·∫°y tay (khi c·∫ßn force build)

jobs:
  # =========================================================
  # JOB 1: CUSTOMER BACKEND (Customer + Worker)
  # =========================================================
  deploy-customer:
    name: Build Customer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # üß† LOGIC TH√îNG MINH: X√°c ƒë·ªãnh Tag v√† Hook d·ª±a tr√™n nh√°nh
      - name: Determine Environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Environment: PRODUCTION"
            echo "TAG=latest" >> $GITHUB_OUTPUT
            echo "RENDER_HOOK=${{ secrets.RENDER_HOOK_CUSTOMER }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "Environment: STAGING"
            echo "TAG=staging" >> $GITHUB_OUTPUT
            # N·∫øu ch∆∞a c√≥ bi·∫øn Staging, d√≤ng d∆∞·ªõi s·∫Ω ƒë·ªÉ tr·ªëng, script kh√¥ng l·ªói
            echo "RENDER_HOOK=${{ secrets.RENDER_HOOK_CUSTOMER_STAGING }}" >> $GITHUB_OUTPUT
          else
            echo "Environment: DEV"
            echo "TAG=dev" >> $GITHUB_OUTPUT
            echo "RENDER_HOOK=" >> $GITHUB_OUTPUT
          fi

      - name: Build & Push (Customer)
        uses: docker/build-push-action@v5
        with:
          context: .
          # ƒê∆∞·ªùng d·∫´n ch√≠nh x√°c t·ªõi Dockerfile Customer
          file: ./apps/customer-backend/Dockerfile
          push: true
          # Tag ƒë·ªông: :latest ho·∫∑c :staging
          tags: hoanphuc/printz-customer-backend:${{ steps.env.outputs.TAG }}
          # C∆° ch·∫ø Cache th√¥ng minh
          cache-from: type=registry,ref=hoanphuc/printz-customer-backend:cache
          cache-to: type=registry,ref=hoanphuc/printz-customer-backend:cache,mode=max

      # Ch·ªâ g·ªçi Render n·∫øu c√≥ Hook (Tr√°nh l·ªói ƒë·ªè n·∫øu ƒëang test dev)
      - name: Trigger Render Deploy
        if: steps.env.outputs.RENDER_HOOK != ''
        run: |
          echo "Triggering Render Deploy for tag: ${{ steps.env.outputs.TAG }}..."
          curl -X POST ${{ steps.env.outputs.RENDER_HOOK }}

  # =========================================================
  # JOB 2: ADMIN BACKEND
  # =========================================================
  deploy-admin:
    name: Build Admin
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # üß† LOGIC TH√îNG MINH (T∆∞∆°ng t·ª± Customer)
      - name: Determine Environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "TAG=latest" >> $GITHUB_OUTPUT
            echo "RENDER_HOOK=${{ secrets.RENDER_HOOK_ADMIN }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "TAG=staging" >> $GITHUB_OUTPUT
            echo "RENDER_HOOK=${{ secrets.RENDER_HOOK_ADMIN_STAGING }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=dev" >> $GITHUB_OUTPUT
            echo "RENDER_HOOK=" >> $GITHUB_OUTPUT
          fi

      - name: Build & Push (Admin)
        uses: docker/build-push-action@v5
        with:
          context: .
          # ƒê∆∞·ªùng d·∫´n ch√≠nh x√°c t·ªõi Dockerfile Admin
          file: ./apps/admin-backend/Dockerfile
          push: true
          tags: hoanphuc/printz-admin-backend:${{ steps.env.outputs.TAG }}
          cache-from: type=registry,ref=hoanphuc/printz-admin-backend:cache
          cache-to: type=registry,ref=hoanphuc/printz-admin-backend:cache,mode=max

      - name: Trigger Render Deploy
        if: steps.env.outputs.RENDER_HOOK != ''
        run: curl -X POST ${{ steps.env.outputs.RENDER_HOOK }}
